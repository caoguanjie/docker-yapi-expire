## mac环境搭建

硬性要求：以下版本一定要低，否则无法编译成功
-  本地node版本：v8.17.0
-  本地npm版本：v6.13.4
-  本地node-gyp版本：v9.3.1
-  本地python环境：2.7.18


## 二次开发步骤
如果需要调整界面或者改变yapi的代码，调整完代码之后，要执行命令之后，才会显示新的代码
```sh
# 打包yapi的客户端
npm run build-client
```
打包好的文件存放在路径：`static`文件夹里面，我们可以选择把`static`文件夹通过docker的复制命令`docker cp`把改变后的界面代码，复制到容器里面

也可以选择通过Dockerfile的文件，生成新的镜像，然后把镜像上传到docker Hub平台，然后再重启docker-compose命令，更新服务。
```sh
# 通过Dockerfile的文件构建镜像，要进入根目录  
docker build -t caoguanjie/docker-yapi:latest .
# 把镜像提交到docker Hub平台
docker push caoguanjie/docker-yapi:latest
# 去到相应的文件夹，执行docker-compose命令更新服务，记得要修改镜像的版本
docker-compose up
```
## 安装插件
1. 插件主要依赖`/yapi/config.json`文件，把相应的插件下载到node_mudules之后，修改config.json文件即可。
2. 由于我该项目只保留的`/vendors`文件夹里面的代码，所以我把config.json的文件也放根目录地下了，因此我修改了`ykit.config.js`文件中的`initPlugins`方法，改了config.json的路径

## 数据备份
1. 先编写shell脚本进行数据库的备份操作
```sh
# 路径： mongo-backup.sh
# -h 连接的数据库地址， -d 数据库名称，-o 导出路径， -u 用户名， -p 密码
mongodump -h 127.0.0.1:27017 -d yapi -o /data/db/backup 


# 把数据库文件打包,压缩包的名字类似：yapi_2023-08-23.tar.gz
tar -zcvf  /data/db/backup/yapi_$(date +%F).tar.gz /data/db/backup/yapi

# 删除目录
rm -rf /data/db/backup/yapi
```

2. 设置定时任务。
```sh
# 进到容器的终端中，输入crontab -e 
# 设置定时任务，执行下面的命令会进去一个配置文件中去
crontab -e 
# 进到配置文件后，键盘输入： i，进行修改
# 加上一条定时任务
# 可以去菜鸟教程查看crontab命令：https://www.runoob.com/w3cnote/linux-crontab-tasks.html

# 定义每周六进行数据库备份
*   *   *   *   6   sh /yapi/vendors/mongo-backup.sh

# 进行上面操作后，键盘输入 esc + :wq(退出并保存)
# ！！！！！注意保存前，一定要删除容器中其他的定时任务，防止占用资源

# cron服务是Linux的内置服务，但它不会开机自动启动。可以用以下命令启动和停止服务
# crond start（启动）、crond stop(停止)、crond restart(重启服务)、crond reload(重新加载)
# 因此我们可以输入下面命令，进行定时器的启动
crond start
```


## 数据还原


## 踩坑记录

如果重新安装，出现如下错误，请删除管理员账号信息
```
(node:20024) UnhandledPromiseRejectionWarning: Error: 初始化管理员账号 "admin@admin.com" 失败, E11000 duplicate key error collection: yapi.user index: email_1 dup key: { : "admin@admin.com" }
```
进入数据库删除管理员账户信息
```sh
mongo

> use yapi;

> db.user.remove({"username":"admin"})
```